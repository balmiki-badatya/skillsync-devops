name: "Manual infra action"

on:
# push:
#   branches:
#     - main
  workflow_dispatch:
    inputs:
      operation:
        type: choice
        description: Infrastructure operation to choose
        options:
          - apply
          - destroy
        default: apply
        required: true  
permissions:
  id-token: write      

jobs:
  Plan-and-apply:
    name: "Clone repository, plan and apply  terraform"
    runs-on: ubuntu-latest
    steps:
      - name: "clone reposotory"
        uses: actions/checkout@v5
      - name: Authenticate with AWS OIDC
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          role-to-assume: ${{ secrets.ASSUME_ROLE }}
      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"
      - name: Terraform initialize
        run: |
          aws sts get-caller-identity
          terraform init -backend-config="vars/ppe.backend.tfvars"
      - name: Terraform plan
        working-directory: .
        run: |
          echo ${{ github.event.inputs.operation }}
          terraform plan -var-file="vars/ppe.tfvars" -out=tfplan
      - name: Terraform apply
        working-directory: .
        if: ${{ inputs.operation == 'apply' }} 
        run: |
          terraform apply -auto-approve tfplan
          terraform show -json tfplan          
      - name: Terraform destroy
        if: ${{ inputs.operation == 'destroy' }} 
        run: |
          terraform plan -destroy -var-file="vars/ppe.tfvars" -out=tfplan-destroy
          terraform show -json tfplan-destroy
          terraform destroy -auto-approve -var-file="vars/ppe.tfvars"
           

