name: "Manual infra action"

on:
  workflow_dispatch:
    inputs:
      operation:
        type: choice
        description: Infrastructure operation to choose
        options:
          - apply
          - destroy
        default: apply
        required: true  
permissions:
  id-token: write      

jobs:
  Plan-and-apply:
    name: "Clone repository, plan and apply  terraform"
    runs-on: ubuntu-latest
    steps:
      - name: "clone reposotory"
        uses: actions/checkout@v5
      - name: Authenticate with AWS OIDC
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          role-to-assume: ${{ secrets.ASSUME_ROLE }}
      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"
      - name: Terraform initialize
        run: |
          aws sts get-caller-identity
          terraform init -backend-config="vars/dev/ppe.backend.tfvars"
      - name: Terraform plan
        working-directory: .
        run: |
          operation=${{ github.event.inputs.operation }}
          echo $operation
          if [ "$operation" = "destroy" ]; then
            terraform plan -destroy -var-file="vars/dev/ppe.tfvars" -out=tfplan-destroy
          else
            terraform plan -var-file="vars/dev/ppe.tfvars" -out=tfplan
          fi
        shell: bash  
      - name: Terraform apply
        working-directory: .
        if: ${{ inputs.operation == 'apply' }} 
        run: |
          terraform show -json tfplan
          terraform apply -auto-approve tfplan
      - name: Terraform destroy
        working-directory: .
        if: ${{ inputs.operation == 'destroy' }} 
        run: |
          terraform show -json tfplan-destroy
          terraform destroy -auto-approve -var-file="vars/dev/ppe.tfvars"
           

